{% extends "base.html" %}

{% block title %}
Chemical Similarity Search - Stack the Future 2026
{% endblock %}

{% block content %}
<div class="my-5">
  <h1 class="text-center mb-4">
    <i class="bi bi-molecule"></i> Chemical Similarity Search
  </h1>
  <p class="text-center text-muted mb-5">
    Find chemically similar compounds using RDKit fingerprints and the ChEMBL database
  </p>

  <!-- Search Form -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <form id="searchForm">
        <div class="mb-3">
          <label for="smilesInput" class="form-label fw-bold">
            Enter SMILES String:
          </label>
          <input 
            type="text" 
            class="form-control form-control-lg" 
            id="smilesInput" 
            placeholder="e.g., CC(=O)Oc1ccccc1C(=O)O (aspirin)"
            required
          >
          <div class="form-text">
            Enter a valid SMILES string representing the chemical structure you want to search for.
          </div>
        </div>

        <div class="row mb-3">
          <div class="col-md-6">
            <label for="limitInput" class="form-label">Maximum Results:</label>
            <input 
              type="number" 
              class="form-control" 
              id="limitInput" 
              value="20" 
              min="1" 
              max="100"
            >
          </div>
          <div class="col-md-6">
            <label for="thresholdInput" class="form-label">Similarity Threshold (%):</label>
            <input 
              type="number" 
              class="form-control" 
              id="thresholdInput" 
              value="70" 
              min="50" 
              max="100"
            >
          </div>
        </div>

        <button type="submit" class="btn btn-primary btn-lg w-100">
          <i class="bi bi-search"></i> Search Similar Compounds
        </button>
      </form>

      <!-- Example SMILES -->
      <div class="mt-4">
        <p class="mb-2 text-muted"><strong>Example SMILES:</strong></p>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-outline-secondary example-btn" data-smiles="CC(=O)Oc1ccccc1C(=O)O">
            Aspirin
          </button>
          <button class="btn btn-sm btn-outline-secondary example-btn" data-smiles="CN1C=NC2=C1C(=O)N(C(=O)N2C)C">
            Caffeine
          </button>
          <button class="btn btn-sm btn-outline-secondary example-btn" data-smiles="CC(C)Cc1ccc(cc1)C(C)C(=O)O">
            Ibuprofen
          </button>
          <button class="btn btn-sm btn-outline-secondary example-btn" data-smiles="CN(C)CCc1c[nH]c2ccc(cc12)CS(=O)(=O)N">
            Sumatriptan
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading Spinner -->
  <div id="loadingSpinner" class="text-center my-5" style="display: none;">
    <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Searching ChEMBL database...</p>
  </div>

  <!-- Error Alert -->
  <div id="errorAlert" class="alert alert-danger" role="alert" style="display: none;">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <span id="errorMessage"></span>
  </div>

  <!-- Results Section -->
  <div id="resultsSection" style="display: none;">
    <div class="card shadow-sm">
      <div class="card-header bg-success text-white">
        <h5 class="mb-0">
          <i class="bi bi-check-circle"></i> 
          Search Results: <span id="resultCount">0</span> compounds found
        </h5>
        <small>Query: <code id="querySmiles" class="text-white"></code></small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover mb-0" id="resultsTable">
            <thead class="table-light">
              <tr>
                <th style="cursor: pointer;" onclick="sortTable(0)">
                  Rank <i class="bi bi-arrow-down-up"></i>
                </th>
                <th style="cursor: pointer;" onclick="sortTable(1)">
                  ChEMBL ID <i class="bi bi-arrow-down-up"></i>
                </th>
                <th style="cursor: pointer;" onclick="sortTable(2)">
                  Name <i class="bi bi-arrow-down-up"></i>
                </th>
                <th style="cursor: pointer;" onclick="sortTable(3)">
                  SMILES <i class="bi bi-arrow-down-up"></i>
                </th>
                <th style="cursor: pointer;" onclick="sortTable(4)">
                  Similarity Score <i class="bi bi-arrow-down-up"></i>
                </th>
              </tr>
            </thead>
            <tbody id="resultsBody">
              <!-- Results will be inserted here -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block styles %}
<style>
  .example-btn {
    font-size: 0.85rem;
  }
  
  .example-btn:hover {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }
  
  #resultsTable th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
  }
  
  #resultsTable tbody tr:hover {
    background-color: #f0f8ff;
  }
  
  .similarity-badge {
    font-size: 1rem;
    font-weight: bold;
  }
  
  code {
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9rem;
  }
</style>
{% endblock %}

{% block scripts %}
<script>
  // Example SMILES buttons
  document.querySelectorAll('.example-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('smilesInput').value = this.dataset.smiles;
    });
  });

  // Form submission
  document.getElementById('searchForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const smiles = document.getElementById('smilesInput').value.trim();
    const limit = parseInt(document.getElementById('limitInput').value);
    const threshold = parseInt(document.getElementById('thresholdInput').value);
    
    if (!smiles) {
      showError('Please enter a SMILES string');
      return;
    }
    
    // Show loading, hide results and errors
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('errorAlert').style.display = 'none';
    
    try {
      const response = await fetch('/api/search-similar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          smiles: smiles,
          limit: limit,
          threshold: threshold
        })
      });
      
      const data = await response.json();
      
      if (!response.ok) {
        throw new Error(data.error || 'Search failed');
      }
      
      displayResults(data);
      
    } catch (error) {
      showError(error.message);
    } finally {
      document.getElementById('loadingSpinner').style.display = 'none';
    }
  });

  function displayResults(data) {
    const resultsBody = document.getElementById('resultsBody');
    resultsBody.innerHTML = '';
    
    document.getElementById('querySmiles').textContent = data.query_smiles;
    document.getElementById('resultCount').textContent = data.count;
    
    if (data.results.length === 0) {
      resultsBody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No similar compounds found. Try lowering the similarity threshold.</td></tr>';
    } else {
      data.results.forEach((compound, index) => {
        const row = document.createElement('tr');
        
        // Determine badge color based on similarity
        let badgeClass = 'bg-success';
        if (compound.similarity < 0.7) badgeClass = 'bg-warning';
        if (compound.similarity < 0.5) badgeClass = 'bg-secondary';
        
        row.innerHTML = `
          <td class="text-center">${index + 1}</td>
          <td>
            <a href="https://www.ebi.ac.uk/chembl/compound_report_card/${compound.chembl_id}/" 
               target="_blank" 
               class="text-decoration-none">
              ${compound.chembl_id} <i class="bi bi-box-arrow-up-right"></i>
            </a>
          </td>
          <td>${compound.name || 'Unknown'}</td>
          <td><code>${compound.smiles}</code></td>
          <td>
            <span class="badge ${badgeClass} similarity-badge">
              ${compound.similarity.toFixed(3)}
            </span>
          </td>
        `;
        
        resultsBody.appendChild(row);
      });
    }
    
    document.getElementById('resultsSection').style.display = 'block';
  }

  function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorAlert').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
  }

  // Simple table sorting
  let sortDirection = {};
  
  function sortTable(columnIndex) {
    const table = document.getElementById('resultsTable');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Toggle sort direction
    sortDirection[columnIndex] = !sortDirection[columnIndex];
    const ascending = sortDirection[columnIndex];
    
    rows.sort((a, b) => {
      let aValue = a.cells[columnIndex].textContent.trim();
      let bValue = b.cells[columnIndex].textContent.trim();
      
      // Try to parse as number
      const aNum = parseFloat(aValue);
      const bNum = parseFloat(bValue);
      
      if (!isNaN(aNum) && !isNaN(bNum)) {
        return ascending ? aNum - bNum : bNum - aNum;
      }
      
      // String comparison
      return ascending ? 
        aValue.localeCompare(bValue) : 
        bValue.localeCompare(aValue);
    });
    
    // Re-append sorted rows
    rows.forEach(row => tbody.appendChild(row));
  }
</script>
{% endblock %}