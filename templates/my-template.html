{% extends "base.html" %}

{% block title %}Chemical Similarity Search - Stack the Future 2026{% endblock %}

{% block content %}
  <div class="my-5">
    <h1 class="text-center mb-4">
      <i class="bi bi-molecule"></i> Chemical Similarity Search
    </h1>
    <p class="text-center text-muted mb-5">
      Find chemically similar compounds using RDKit fingerprints and the ChEMBL database
    </p>

    <!-- Search Form -->
    <div class="card shadow-sm mb-4">
      <div class="card-body">
        <form id="searchForm">
          <div class="mb-3">
            <label for="smilesInput" class="form-label fw-bold">Enter SMILES String:</label>
            <input type="text"
                   class="form-control form-control-lg"
                   id="smilesInput"
                   placeholder="e.g., CC(=O)Oc1ccccc1C(=O)O (aspirin)">
            <div class="form-text">Enter a valid SMILES string representing the chemical structure you want to search for.</div>
          </div>

          <div class="mb-3">
            <label for="nameInput" class="form-label fw-bold">Or enter Compound Name:</label>
            <input type="text"
                   class="form-control"
                   id="nameInput"
                   placeholder="e.g., Aspirin">
            <div class="form-text">
              If you don't have a SMILES string, enter a compound name. The app will resolve it to SMILES via ChEMBL.
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label for="limitInput" class="form-label">Maximum Results:</label>
              <input type="number"
                     class="form-control"
                     id="limitInput"
                     value="20"
                     min="1"
                     max="100">
            </div>
            <div class="col-md-6">
              <label for="thresholdInput" class="form-label">Similarity Threshold (%):</label>
              <input type="number"
                     class="form-control"
                     id="thresholdInput"
                     value="70"
                     min="50"
                     max="100">
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-lg w-100">
            <i class="bi bi-search"></i> Search Similar Compounds
          </button>
        </form>

    <!-- Loading Spinner -->
    <div id="loadingSpinner" class="text-center my-5" style="display: none;">
      <div class="spinner-border text-primary"
           role="status"
           style="width: 3rem;
                  height: 3rem">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-3 text-muted">Searching ChEMBL database...</p>
    </div>

    <!-- Error Alert -->
    <div id="errorAlert"
         class="alert alert-danger"
         role="alert"
         style="display: none">
      <i class="bi bi-exclamation-triangle-fill"></i>
      <span id="errorMessage"></span>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
      <div class="card shadow-sm">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="bi bi-check-circle"></i>
            Search Results: <span id="resultCount">0</span> compounds found
          </h5>
          <small>Query: <code id="querySmiles" class="text-white"></code></small>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table mb-0" id="resultsTable">
              <thead class="table-light">
                <tr>
                  <th>Rank</th>
                  <th>Structure</th>
                  <th>ChEMBL ID</th>
                  <th>Name</th>
                  <th>SMILES</th>
                  <th>Similarity Score</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="resultsBody">
                <!-- Results will be inserted here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block styles %}
  <style>
  .example-btn {
    font-size: 0.85rem;
  }

  .example-btn:hover {
    background-color: #0d6efd;
    color: white;
    border-color: #0d6efd;
  }

  #resultsTable th {
    position: sticky;
    top: 0;
    background-color: #f8f9fa;
    z-index: 10;
  }

  #resultsTable tbody tr:hover {
    background-color: #f0f8ff;
  }

  .similarity-badge {
    font-size: 1rem;
    font-weight: bold;
  }

  code {
    background-color: #f8f9fa;
    padding: 2px 6px;
    border-radius: 3px;
    font-size: 0.9rem;
  }

  .molecule-image {
    max-width: 200px;
    height: auto;
    border: 1px solid #dee2e6;
    border-radius: 4px;
  }

  .descriptor-row {
    background-color: #f8f9fa;
    border-top: 2px solid #dee2e6;
  }

  .descriptor-content {
    padding: 15px;
  }

  .descriptor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 10px;
  }

  .descriptor-item {
    background: white;
    padding: 8px 12px;
    border-radius: 4px;
    border: 1px solid #dee2e6;
  }

  .descriptor-name {
    font-weight: 600;
    color: #000a15;
    font-size: 0.85rem;
  }

  .descriptor-value {
    color: #0d6efd;
    font-size: 0.9rem;
    font-family: monospace;
  }
  </style>
{% endblock %}

{% block scripts %}
  <script>
  // Example SMILES buttons
  document.querySelectorAll('.example-btn').forEach(btn => {
    btn.addEventListener('click', function (e) {
      e.preventDefault();
      document.getElementById('smilesInput').value = this.dataset.smiles;
    });
  });

  // Form submission
  document.getElementById('searchForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    const smiles = document.getElementById('smilesInput').value.trim();
    const compoundName = (document.getElementById('nameInput') && document.getElementById('nameInput').value.trim()) || '';
    const limit = parseInt(document.getElementById('limitInput').value);
    const threshold = parseInt(document.getElementById('thresholdInput').value);

    if (!smiles && !compoundName) {
      showError('Please enter a SMILES string or a compound name');
      return;
    }

    // Show loading, hide results and errors
    document.getElementById('loadingSpinner').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
    document.getElementById('errorAlert').style.display = 'none';

    try {
      const response = await fetch('/api/search-similar', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          smiles: smiles,
          compound_name: compoundName,
          limit: limit,
          threshold: threshold
        })
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || 'Search failed');
      }

      displayResults(data);

    } catch (error) {
      showError(error.message);
    } finally {
      document.getElementById('loadingSpinner').style.display = 'none';
    }
  });

  function displayResults(data) {
    const resultsBody = document.getElementById('resultsBody');
    resultsBody.innerHTML = '';
    
    // Prefer showing the query name (and resolved SMILES) if the user searched by name
    if (data.query_name) {
      document.getElementById('querySmiles').textContent = `${data.query_name} (${data.query_smiles})`;
    } else {
      document.getElementById('querySmiles').textContent = data.query_smiles;
    }
    document.getElementById('resultCount').textContent = data.count;

    if (data.results.length === 0) {
      resultsBody.innerHTML = '<tr><td colspan="7" class="text-center text-muted py-4">No similar compounds found. Try lowering the similarity threshold.</td></tr>';
    } else {
      data.results.forEach((compound, index) => {
        const rowId = `compound-${index}`;
        const descriptorId = `descriptors-${index}`;

        // Determine badge color based on similarity
        let badgeClass = 'bg-success';
        if (compound.similarity < 0.7) badgeClass = 'bg-warning';
        if (compound.similarity < 0.5) badgeClass = 'bg-secondary';

        // Main compound row
        const row = document.createElement('tr');
        row.id = rowId;
        row.innerHTML = `
          <td class="text-center">${index + 1}</td>
          <td class="text-center">
            ${compound.image ? `<img src="${compound.image}" class="molecule-image" alt="Structure">` : 'N/A'}
          </td>
          <td>
            <a href="https://www.ebi.ac.uk/chembl/compound_report_card/${compound.chembl_id}/" target="_blank" class="text-decoration-none">
              ${compound.chembl_id} <i class="bi bi-box-arrow-up-right"></i>
            </a>
          </td>
          <td>${compound.name || 'Unknown'}</td>
          <td><code style="font-size: 0.75rem;">${compound.smiles}</code></td>
          <td>
            <span class="badge ${badgeClass} similarity-badge">
              ${compound.similarity.toFixed(3)}
            </span>
          </td>
          <td class="text-center">
            <button class="btn btn-sm btn-outline-primary" onclick="toggleDescriptors('${descriptorId}', this)" type="button">
              <i class="bi bi-chevron-down"></i> Details
            </button>
          </td>
        `;

        resultsBody.appendChild(row);

        // Descriptor row (hidden by default)
        const descriptorRow = document.createElement('tr');
        descriptorRow.className = 'descriptor-row';
        descriptorRow.id = descriptorId;
        descriptorRow.style.display = 'none';
        descriptorRow.innerHTML = `
          <td colspan="7">
            <div class="descriptor-content">
              <h6 class="mb-3"><i class="bi bi-clipboard-data"></i> Molecular Descriptors</h6>
              <div class="descriptor-grid">
                ${formatDescriptors(compound.descriptors)}
              </div>
            </div>
          </td>
        `;

        resultsBody.appendChild(descriptorRow);
      });
    }

    document.getElementById('resultsSection').style.display = 'block';
  }

  function formatDescriptors(descriptors) {
    if (!descriptors || descriptors.error) {
      return '<div class="text-muted">Descriptors not available</div>';
    }

    let html = '';
    for (const [name, value] of Object.entries(descriptors)) {
      html += `
        <div class="descriptor-item">
          <div class="descriptor-name">${name}</div>
          <div class="descriptor-value">${value}</div>
        </div>
      `;
    }
    return html;
  }

  function toggleDescriptors(descriptorId, button) {
    const descriptorRow = document.getElementById(descriptorId);
    const icon = button.querySelector('i');

    if (descriptorRow.style.display === 'none') {
      descriptorRow.style.display = 'table-row';
      icon.className = 'bi bi-chevron-up';
      button.innerHTML = '<i class="bi bi-chevron-up"></i> Hide';
    } else {
      descriptorRow.style.display = 'none';
      icon.className = 'bi bi-chevron-down';
      button.innerHTML = '<i class="bi bi-chevron-down"></i> Details';
    }
  }

  function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorAlert').style.display = 'block';
    document.getElementById('resultsSection').style.display = 'none';
  }
  </script>
{% endblock %}
